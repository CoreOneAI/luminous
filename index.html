<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Stylist Portal · Luminous Beauty</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .chip{padding:.375rem .625rem;border-radius:999px;border:1px solid #e5e7eb;font-size:.75rem;display:inline-flex;gap:.375rem;align-items:center;background:#fff}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:.65rem .9rem;border-radius:12px;font-weight:600}
    .btn-accent{background:linear-gradient(90deg,#f472b6,#8b5cf6);color:#fff}
    .btn-subtle{background:#f3f4f6;color:#111827}
    .swatch{width:24px;height:24px;border-radius:6px;border:1px solid rgba(0,0,0,.06)}
    .imgcell{position:relative}
    .imgcell input[type="file"]{position:absolute;inset:0;opacity:0;cursor:pointer}
    .print h1 { font-size: 18px; font-weight: 700; margin: 0 0 6px; }
    .print h2 { font-size: 14px; font-weight: 600; margin: 12px 0 4px; }
    .print p, .print li { font-size: 12px; line-height: 1.45; }
  </style>
</head>
<body class="min-h-screen bg-white">
  <header class="px-4 pt-6 pb-4">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-pink-400 to-violet-500 shadow-sm"></div>
        <div>
          <h1 class="text-lg font-extrabold tracking-tight">Stylist Portal</h1>
          <p class="text-xs text-gray-500 -mt-0.5">Client brief & inspo tools</p>
        </div>
      </div>
      <a href="/" class="text-sm text-gray-500 hover:text-gray-800">← Back to Shop</a>
    </div>
  </header>

  <main class="px-4">
    <!-- Ask AI (independent of products) -->
    <section class="card p-4 border rounded-2xl">
      <h2 class="text-base font-semibold mb-3">Ask AI (independent)</h2>
      <div class="flex gap-2">
        <input id="aiInput" class="flex-1 rounded-lg border border-gray-200 px-3 py-2 text-[15px] outline-none focus:ring-2 focus:ring-pink-300"
               placeholder="Tell me the vibe, event, skin/hair details, celebs, etc." />
        <button id="aiBtn" class="btn btn-accent px-4">Ask</button>
      </div>
      <div class="mt-3 flex gap-2 flex-wrap" id="aiChips">
        <button class="chip" data-q="Romantic soft glam for evening dinner, fair skin, cool undertone, shoulder-length hair">Romantic soft glam</button>
        <button class="chip" data-q="Beach wedding daytime, light coverage, waterproof eye look">Beach wedding</button>
        <button class="chip" data-q="Editorial look, bold liner, short curly hair">Editorial bold</button>
      </div>
      <div id="aiOutWrap" class="mt-4 hidden">
        <div class="text-xs font-semibold text-gray-500 mb-2">AI Generated</div>
        <div id="aiOut" class="prose prose-sm max-w-none text-[15px] leading-6"></div>
      </div>
    </section>

    <!-- Undertone & Hair quick helpers -->
    <section class="grid grid-cols-2 gap-3 mt-4">
      <div class="card p-4 border rounded-2xl">
        <h3 class="text-sm font-semibold mb-2">Skin Undertone</h3>
        <div class="flex gap-2">
          <button class="chip" data-und="cool">Cool</button>
          <button class="chip" data-und="neutral">Neutral</button>
          <button class="chip" data-und="warm">Warm</button>
        </div>
        <p id="undNote" class="text-xs text-gray-500 mt-2">Pick an undertone to seed suggestions.</p>
      </div>
      <div class="card p-4 border rounded-2xl">
        <h3 class="text-sm font-semibold mb-2">Hair Type • Event</h3>
        <div class="flex gap-2 flex-wrap">
          <button class="chip" data-hair="straight">Straight</button>
          <button class="chip" data-hair="wavy">Wavy</button>
          <button class="chip" data-hair="curly">Curly</button>
          <button class="chip" data-hair="coily">Coily</button>
          <button class="chip" data-event="day">Day</button>
          <button class="chip" data-event="evening">Evening</button>
          <button class="chip" data-event="photo">Photo/On-camera</button>
        </div>
        <p id="hairNote" class="text-xs text-gray-500 mt-2">Pick hair/event to refine the brief.</p>
      </div>
    </section>

    <!-- Moodboard: paste/upload images -->
    <section class="card p-4 border rounded-2xl mt-4">
      <div class="flex items-center justify-between">
        <h2 class="text-base font-semibold">Add inspo images</h2>
        <div class="flex gap-2 items-center">
          <div id="sw1" class="swatch"></div>
          <div id="sw2" class="swatch"></div>
          <div id="sw3" class="swatch"></div>
        </div>
      </div>
      <p class="text-xs text-gray-500 mt-1">Images remain in-session only (not uploaded to server).</p>

      <div id="mood" class="grid grid-cols-3 gap-3 mt-3">
        <!-- image cells get appended here -->
        <div class="imgcell aspect-square bg-gray-50 border rounded-xl flex items-center justify-center text-gray-400 text-sm">
          + Add
          <input type="file" accept="image/*" />
        </div>
      </div>
    </section>

    <!-- AI Brief -->
    <section class="card p-4 border rounded-2xl mt-4">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-base font-semibold">AI Brief</h2>
        <div class="flex gap-2">
          <button id="openStylist" class="btn btn-subtle">Open Stylist View</button>
          <button id="exportPDF" class="btn btn-accent">Export PDF</button>
        </div>
      </div>
      <textarea id="brief" class="w-full border rounded-lg p-3 text-sm h-40"
        placeholder="Brief will build here from your selections, images & AI…"></textarea>
      <p class="text-[11px] text-gray-500 mt-2">Demo • No PII stored • Images kept in session only.</p>
    </section>

  </main>

  <script>
    const CHAT_PATH = '/ask';

    const $ = (sel, root=document) => root.querySelector(sel);

    // --- Ask AI ---
    const aiInput = $('#aiInput');
    const aiBtn = $('#aiBtn');
    const aiChips = $('#aiChips');
    const aiOutWrap = $('#aiOutWrap');
    const aiOut = $('#aiOut');

    function showAI(text) {
      aiOutWrap.classList.remove('hidden');
      aiOut.textContent = text;
    }

    async function doAsk(q) {
      if (!q) return;
      showAI('…');
      try {
        const r = await fetch(CHAT_PATH, {
          method:'POST',
          headers:{'content-type':'application/json'},
          body: JSON.stringify({ message: q })
        });
        const data = await r.json().catch(()=>({}));
        showAI(data.reply || 'Sorry, I could not find helpful suggestions.');
      } catch {
        showAI('An error occurred while processing your request.');
      }
    }

    aiBtn.addEventListener('click', () => doAsk(aiInput.value.trim()));
    aiInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') doAsk(aiInput.value.trim()); });
    aiChips.addEventListener('click', (e) => {
      const el = e.target.closest('[data-q]');
      if (!el) return;
      aiInput.value = el.dataset.q;
      doAsk(el.dataset.q);
    });

    // --- Undertone / Hair / Event chips build the brief seed ---
    const brief = $('#brief');
    $('#undNote').parentElement.addEventListener('click', (e)=>{
      const b = e.target.closest('[data-und]');
      if (!b) return;
      brief.value += (brief.value ? '\n' : '') + `Undertone: ${b.dataset.und}`;
    });
    $('#hairNote').parentElement.addEventListener('click', (e)=>{
      const h = e.target.closest('[data-hair]');
      const v = e.target.closest('[data-event]');
      if (h) brief.value += (brief.value ? '\n' : '') + `Hair: ${h.dataset.hair}`;
      if (v) brief.value += (brief.value ? '\n' : '') + `Event: ${v.dataset.event}`;
    });

    // --- Moodboard (local only) & palette ---
    const mood = $('#mood');
    const sw1 = $('#sw1'), sw2 = $('#sw2'), sw3 = $('#sw3');

    mood.addEventListener('change', (e) => {
      const input = e.target;
      if (input.type !== 'file' || !input.files?.[0]) return;
      const file = input.files[0];
      const url = URL.createObjectURL(file);

      // replace the +Add cell with image preview + create a new +Add cell
      const cell = input.parentElement;
      cell.innerHTML = `<img src="${url}" class="w-full h-full object-cover rounded-xl" alt="inspo">`;

      const add = document.createElement('div');
      add.className = 'imgcell aspect-square bg-gray-50 border rounded-xl flex items-center justify-center text-gray-400 text-sm';
      add.textContent = '+ Add';
      const finput = document.createElement('input');
      finput.type = 'file';
      finput.accept = 'image/*';
      add.appendChild(finput);
      mood.appendChild(add);

      // palette
      extractPalette(url).then(cols => {
        [sw1,sw2,sw3].forEach((sw,i)=> { if(cols[i]) sw.style.background = cols[i]; });
        brief.value += (brief.value ? '\n' : '') + `Palette: ${cols.join(', ')}`;
      });
    });

    function extractPalette(url) {
      return new Promise((resolve) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => {
          const canvas = document.createElement('canvas');
          const W = canvas.width = 120, H = canvas.height = 120;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, W, H);
          const data = ctx.getImageData(0,0,W,H).data;

          // Very simple k-means-ish 3 swatch quantization
          const buckets = [{r:220,g:220,b:220,c:1},{r:120,g:120,b:120,c:1},{r:40,g:40,b:40,c:1}];
          for (let i=0;i<data.length;i+=4) {
            const r=data[i], g=data[i+1], b=data[i+2];
            let bi=0, best=1e9;
            for (let j=0;j<buckets.length;j++){
              const d = (r-buckets[j].r)**2+(g-buckets[j].g)**2+(b-buckets[j].b)**2;
              if (d<best){best=d;bi=j;}
            }
            const bk = buckets[bi]; bk.r+=r; bk.g+=g; bk.b+=b; bk.c++;
          }
          const cols = buckets.map(b=>{
            const r=(b.r/b.c)|0, g=(b.g/b.c)|0, b2=(b.b/b.c)|0;
            return `rgb(${r}, ${g}, ${b2})`;
          });
          resolve(cols);
        };
        img.src = url;
      });
    }

    // --- Stylist View (read-only) & PDF ---
    $('#openStylist').addEventListener('click', () => {
      const w = window.open('', '_blank');
      if (!w) return;
      w.document.write(`
        <html><head><title>Stylist View</title>
        <style>
          body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; padding:20px;}
          .print h1 { font-size: 18px; font-weight: 700; margin: 0 0 6px; }
          .print h2 { font-size: 14px; font-weight: 600; margin: 12px 0 4px; }
          .print p, .print li { font-size: 12px; line-height: 1.45; white-space: pre-wrap; }
        </style></head>
        <body class="print">
          <h1>Luminous Beauty — Client Brief</h1>
          <p>${brief.value.replaceAll('<','&lt;')}</p>
        </body></html>
      `);
      w.document.close();
    });

    $('#exportPDF').addEventListener('click', () => {
      const w = window.open('', '_blank');
      if (!w) return;
      w.document.write(`
        <html><head><title>Client Brief PDF</title>
        <style>
          body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; padding:20px;}
          .print h1 { font-size: 18px; font-weight: 700; margin: 0 0 6px; }
          .print h2 { font-size: 14px; font-weight: 600; margin: 12px 0 4px; }
          .print p, .print li { font-size: 12px; line-height: 1.45; white-space: pre-wrap; }
        </style></head>
        <body class="print">
          <h1>Luminous Beauty — Client Brief</h1>
          <p>${brief.value.replaceAll('<','&lt;')}</p>
          <script>window.onload = () => window.print()</script>
        </body></html>
      `);
      w.document.close();
    });
  </script>
</body>
</html>
