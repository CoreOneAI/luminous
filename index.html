<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Salon Consultant</title>
  <link rel="stylesheet" href="/css/styles.css">
  <meta name="description" content="Your personal beauty expert powered by AI">
</head>
<body>
  <header>
    <div class="container">
      <h1>Welcome to Your Personal Salon</h1>
      <p>Tell me about your hair, skin, or beauty goals and I'll recommend the perfect professional products just for you.</p>
      <div class="category-buttons">
        <button class="category-btn" data-category="repair">Repair Damage</button>
        <button class="category-btn" data-category="anti-aging">Anti-Aging</button>
        <button class="category-btn" data-category="accessories">Accessories</button>
        <button class="category-btn" data-category="clear-skin">Clear Skin</button>
      </div>
    </div>
  </header>

  <main>
    <section class="chat-section">
      <div class="container">
        <form id="chat-form">
          <input type="text" id="chat-input" placeholder="Ask AI" autocomplete="off">
          <button type="submit">Ask AI</button>
        </form>
        <div id="loading" class="hidden">AI is generating personalized recommendations...</div>
        <div id="chat-response" class="hidden">
          <h3>Welcome to Your AI Salon</h3>
          <p>I'm here to give you personalized product recommendations.</p>
          <p>Try:</p>
          <ul>
            <li>"shampoo"</li>
            <li>"serum"</li>
            <li>"bond repair"</li>
            <li>"accessories"</li>
          </ul>
        </div>
      </div>
    </section>

    <section class="product-section">
      <div class="container">
        <h2>Your Recommendations</h2>
        <p>AI Generated</p>
        <div id="product-list"></div>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <nav>
        <a href="#" class="active">
          <img src="/images/home-icon.png" alt="Home">
          Home
        </a>
        <a href="#">
          <img src="/images/profile-icon.png" alt="Profile">
          Profile
        </a>
        <a href="#">
          <img src="/images/appointments-icon.png" alt="Appointments">
          Appointments
        </a>
        <a href="#">
          <img src="/images/basket-icon.png" alt="Basket">
          Basket
        </a>
      </nav>
    </div>
  </footer>

  <script>
    // Ensure DOM is fully loaded before executing any DOM-related code
    document.addEventListener('DOMContentLoaded', () => {
      // Log DOM state for debugging
      console.log('DOM fully loaded at:', new Date().toISOString());
      const categoryButtonsCheck = document.querySelectorAll('.category-btn');
      console.log('Found', categoryButtonsCheck.length, 'elements with class "category-btn"');

      // Initialize products array
      let products = [];

      // Fetch products on load
      async function loadProducts() {
        try {
          const response = await fetch('/data/products.json');
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          products = await response.json();
          displayProducts(products); // Display all products initially
        } catch (error) {
          console.error('Error loading products:', error);
          const productListDiv = document.getElementById('product-list');
          if (productListDiv) {
            productListDiv.innerHTML = '<p>Error loading products. Please try again later.</p>';
          } else {
            console.error('Product list element not found with ID "product-list"');
          }
        }
      }

      // Function to display products in product-list
      function displayProducts(productList) {
        const productListDiv = document.getElementById('product-list');
        if (!productListDiv) {
          console.error('Product list element not found with ID "product-list"');
          return;
        }
        productListDiv.innerHTML = '';
        if (productList.length === 0) {
          productListDiv.innerHTML = '<p>No products found.</p>';
          return;
        }
        productList.forEach(product => {
          const card = document.createElement('div');
          card.className = 'product-card';
          card.innerHTML = `
            <img src="/images/${encodeURIComponent(product.name.toLowerCase().replace(/ /g, '_'))}.jpg" alt="${product.name}" onerror="this.src='/images/fallback.jpg'">
            <h3>${product.name}</h3>
            <p>Brand: ${product.brand}</p>
            <p>Category: ${product.category}</p>
            <p>${product.instructions}</p>
          `;
          productListDiv.appendChild(card);
        });
      }

      // Category mappings for buttons
      const categoryMappings = {
        'repair': ['repair', 'damaged', 'bond', 'haircare'],
        'anti-aging': ['aging', 'wrinkle', 'anti-aging', 'serum', 'skincare'],
        'accessories': ['tools', 'accessories', 'barber', 'styling'],
        'clear-skin': ['acne', 'clear', 'breakout', 'skincare']
      };

      // Handle category button clicks
      const categoryButtons = document.querySelectorAll('.category-btn');
      if (categoryButtons.length === 0) {
        console.warn('No category buttons found with class "category-btn". Please verify the HTML structure for elements with class="category-btn".');
      } else {
        console.log('Category buttons initialized:', categoryButtons.length);
        categoryButtons.forEach(button => {
          button.addEventListener('click', () => {
            const category = button.dataset.category;
            console.log('Category button clicked:', category);
            const terms = categoryMappings[category] || [];
            const filtered = products.filter(p => {
              const lowerName = p.name.toLowerCase();
              const lowerBrand = p.brand.toLowerCase();
              const lowerCategory = p.category.toLowerCase();
              return terms.some(term => lowerName.includes(term) || lowerBrand.includes(term) || lowerCategory.includes(term));
            });
            displayProducts(filtered);
          });
        });
      }

      // Handle chat form submission
      const chatForm = document.getElementById('chat-form');
      if (!chatForm) {
        console.error('Chat form not found with ID "chat-form". Please verify the HTML structure.');
        return;
      }
      const chatInput = document.getElementById('chat-input');
      const loading = document.getElementById('loading');
      const chatResponse = document.getElementById('chat-response');

      if (!chatInput) {
        console.error('Chat input not found with ID "chat-input".');
      }
      if (!loading) {
        console.error('Loading element not found with ID "loading".');
      }
      if (!chatResponse) {
        console.error('Chat response element not found with ID "chat-response".');
      }

      chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!chatInput) return;
        const message = chatInput.value.trim();
        if (!message) return;

        console.log('Chat form submitted with message:', message);
        chatInput.value = '';
        if (loading) loading.classList.remove('hidden');
        if (chatResponse) chatResponse.classList.add('hidden');
        if (chatResponse) chatResponse.innerHTML = '';

        try {
          const res = await fetch('/api/ai-chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
          });
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          const data = await res.json();
          if (data.response && chatResponse) {
            chatResponse.innerHTML = data.response.text.replace(/\n/g, '<br>');
            displayProducts(data.response.products); // Display products if included in response
          }
        } catch (error) {
          console.error('Error in chat:', error);
          if (chatResponse) {
            chatResponse.innerHTML = 'An error occurred. Please try again.';
          }
        } finally {
          if (loading) loading.classList.add('hidden');
          if (chatResponse) chatResponse.classList.remove('hidden');
        }
      });

      // Load products on page load
      loadProducts();
    });
  </script>
</body>
</html>
