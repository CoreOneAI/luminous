<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Salon Consultant</title>
  <link rel="stylesheet" href="/css/styles.css">
  <meta name="description" content="Your personal beauty expert powered by AI">
</head>
<body>
  <header>
    <div class="container">
      <h1>Welcome to Your Personal Salon</h1>
      <p>Tell me about your hair, skin, or beauty goals and I'll recommend the perfect professional products just for you.</p>
      <div class="category-buttons">
        <button class="category-btn" data-category="repair">Repair Damage</button>
        <button class="category-btn" data-category="anti-aging">Anti-Aging</button>
        <button class="category-btn" data-category="accessories">Accessories</button>
        <button class="category-btn" data-category="clear-skin">Clear Skin</button>
      </div>
    </div>
  </header>

  <main>
    <section class="chat-section">
      <div class="container">
        <form id="chat-form">
          <input type="text" id="chat-input" placeholder="Ask AI" autocomplete="off">
          <button type="submit">Ask AI</button>
        </form>
        <div id="loading" class="hidden">AI is generating personalized recommendations...</div>
        <div id="chat-response" class="hidden">
          <h3>Welcome to Your AI Salon</h3>
          <p>I'm here to give you personalized product recommendations.</p>
          <p>Try:</p>
          <ul>
            <li>"shampoo"</li>
            <li>"serum"</li>
            <li>"bond repair"</li>
            <li>"accessories"</li>
          </ul>
        </div>
      </div>
    </section>

    <section class="product-section">
      <div class="container">
        <h2>Your Recommendations</h2>
        <p>AI Generated</p>
        <div id="product-list"></div>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <nav>
        <a href="#" class="active">
          <img src="/images/home-icon.png" alt="Home">
          Home
        </a>
        <a href="#">
          <img src="/images/profile-icon.png" alt="Profile">
          Profile
        </a>
        <a href="#">
          <img src="/images/appointments-icon.png" alt="Appointments">
          Appointments
        </a>
        <a href="#">
          <img src="/images/basket-icon.png" alt="Basket">
          Basket
        </a>
      </nav>
    </div>
  </footer>

  <script>
    // Ensure DOM is fully loaded before executing any DOM-related code
    document.addEventListener('DOMContentLoaded', () => {
      // Log DOM state for debugging
      console.log('DOM fully loaded at:', new Date().toISOString());
      const categoryButtonsCheck = document.querySelectorAll('.category-btn');
      console.log('Initial check: Found', categoryButtonsCheck.length, 'elements with class "category-btn"');
      console.log('Script initialization started for https://luminous-render.onrender.com/');

      // Initialize products array
      let products = [];

      // Format price in cents to dollars (e.g., 1234 -> $12.34)
      function formatCents(cents) {
        if (typeof cents !== 'number' || isNaN(cents)) {
          console.warn('Invalid price value:', cents);
          return 'N/A';
        }
        return `$${(cents / 100).toFixed(2)}`;
      }

      // Generate HTML for a single product card
      function card(product) {
        return `
          <div class="product-card">
            <img src="/images/${encodeURIComponent(product.name.toLowerCase().replace(/ /g, '_'))}.jpg" alt="${product.name}" onerror="this.src='/images/fallback.jpg'">
            <h3>${product.name}</h3>
            <p>Brand: ${product.brand}</p>
            <p>Category: ${product.category}</p>
            <p>Price: ${formatCents(product.price)}</p>
            <p>${product.instructions}</p>
          </div>
        `;
      }

      // Render products in product-list
      function renderProducts(productList) {
        const productListDiv = document.getElementById('product-list');
        if (!productListDiv) {
          console.error('Product list element not found with ID "product-list"');
          return;
        }
        productListDiv.innerHTML = '';
        if (!Array.isArray(productList) || productList.length === 0) {
          productListDiv.innerHTML = '<p>No products found.</p>';
          return;
        }
        productListDiv.innerHTML = productList.map(product => card(product)).join('');
      }

      // Fetch products on load
      async function loadProducts() {
        try {
          const response = await fetch('/data/products.json');
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          products = await response.json();
          renderProducts(products); // Display all products initially
        } catch (error) {
          console.error('Error loading products:', error);
          const productListDiv = document.getElementById('product-list');
          if (productListDiv) {
            productListDiv.innerHTML = '<p>Error loading products. Please try again later.</p>';
          } else {
            console.error('Product list element not found with ID "product-list"');
          }
        }
      }

      // Category mappings for buttons
      const categoryMappings = {
        'repair': ['repair', 'damaged', 'bond', 'haircare'],
        'anti-aging': ['aging', 'wrinkle', 'anti-aging', 'serum', 'skincare'],
        'accessories': ['tools', 'accessories', 'barber', 'styling'],
        'clear-skin': ['acne', 'clear', 'breakout', 'skincare']
      };

      // Retry mechanism for category buttons
      function initializeCategoryButtons(attempt = 1, maxAttempts = 3, delayMs = 500) {
        const categoryButtons = document.querySelectorAll('.category-btn');
        if (categoryButtons.length === 0) {
          console.warn(`Attempt ${attempt}/${maxAttempts}: No category buttons found with class "category-btn". Please verify the HTML structure for elements with class="category-btn" in <div class="category-buttons">.`);
          if (attempt < maxAttempts) {
            console.log(`Retrying in ${delayMs}ms...`);
            setTimeout(() => initializeCategoryButtons(attempt + 1, maxAttempts, delayMs), delayMs);
            return;
          } else {
            console.error('All attempts failed: Category buttons not found. Proceeding without category button functionality.');
            return;
          }
        }

        console.log('Category buttons initialized:', categoryButtons.length);
        categoryButtons.forEach(button => {
          button.addEventListener('click', () => {
            const category = button.dataset.category;
            console.log('Category button clicked:', category);
            const terms = categoryMappings[category] || [];
            const filtered = products.filter(p => {
              const lowerName = p.name.toLowerCase();
              const lowerBrand = p.brand.toLowerCase();
              const lowerCategory = p.category.toLowerCase();
              return terms.some(term => lowerName.includes(term) || lowerBrand.includes(term) || lowerCategory.includes(term));
            });
            renderProducts(filtered);
          });
        });
      }

      // Handle chat form submission
      function handleAsk(e) {
        e.preventDefault();
        const chatInput = document.getElementById('chat-input');
        const loading = document.getElementById('loading');
        const chatResponse = document.getElementById('chat-response');

        if (!chatInput) {
          console.error('Chat input not found with ID "chat-input"');
          return;
        }
        if (!loading) {
          console.error('Loading element not found with ID "loading"');
          return;
        }
        if (!chatResponse) {
          console.error('Chat response element not found with ID "chat-response"');
          return;
        }

        const message = chatInput.value.trim();
        if (!message) return;

        console.log('Chat form submitted with message:', message);
        chatInput.value = '';
        loading.classList.remove('hidden');
        chatResponse.classList.add('hidden');
        chatResponse.innerHTML = '';

        fetch('/api/ai-chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        })
          .then(res => {
            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
          })
          .then(data => {
            if (data.response && chatResponse) {
              chatResponse.innerHTML = data.response.text.replace(/\n/g, '<br>');
              renderProducts(data.response.products); // Display AI-recommended products
            }
          })
          .catch(error => {
            console.error('Error in chat:', error);
            if (chatResponse) {
              chatResponse.innerHTML = 'An error occurred. Please try again.';
            }
          })
          .finally(() => {
            loading.classList.add('hidden');
            chatResponse.classList.remove('hidden');
          });
      }

      // Utility function to bind event listeners
      function bind(element, event, handler) {
        if (!element) {
          console.error(`Cannot bind event "${event}" to undefined or null element`);
          return;
        }
        element.addEventListener(event, handler);
        console.log(`Bound event "${event}" to element with ID "${element.id || element.tagName}"`);
      }

      // Initialize chat form
      const chatForm = document.getElementById('chat-form');
      if (!chatForm) {
        console.error('Chat form not found with ID "chat-form". Please verify the HTML structure.');
        return;
      }
      bind(chatForm, 'submit', handleAsk);

      // Initialize category buttons with retry mechanism
      initializeCategoryButtons();

      // Load products on page load
      loadProducts();
    });
  </script>
</body>
</html>
