<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Luminous Beauty</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="light only" />
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --brand:#111827; --accent:#f472b6; --accent2:#8b5cf6; }
    html,body { background:#fff; font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .chip{padding:.375rem .625rem;border-radius:999px;border:1px solid #e5e7eb;font-size:.75rem;display:inline-flex;gap:.375rem;align-items:center;background:#fff}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:.75rem 1rem;border-radius:12px;font-weight:600}
    .btn-accent{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff}
    .btn-subtle{background:#f3f4f6;color:#111827}
    .card{background:#fff;border:1px solid #eef2f7;border-radius:16px;box-shadow:0 6px 14px rgba(17,24,39,.05)}
    .skeleton{background:linear-gradient(90deg,#f3f4f6,#e5e7eb,#f3f4f6);background-size:200% 100%;animation:shimmer 1.2s infinite}
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .sticky-bottom{position:sticky;bottom:0;background:#fff;padding:10px 0}
  </style>
</head>
<body class="min-h-screen">
  <!-- Header -->
  <header class="px-4 pt-6 pb-4">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-pink-400 to-violet-500 shadow-sm"></div>
        <div>
          <h1 class="text-lg font-extrabold tracking-tight">Luminous Beauty</h1>
          <p class="text-xs text-gray-500 -mt-0.5">Personal beauty concierge</p>
        </div>
      </div>
      <span id="statusDot" class="inline-flex items-center gap-2 text-xs text-gray-500">
        <span class="h-2 w-2 rounded-full bg-gray-300" aria-hidden="true"></span>
        Offline
      </span>
    </div>
  </header>

  <!-- Hero notice -->
  <section class="px-4 -mt-2 mb-2">
    <div class="card px-4 py-3">
      <p class="text-[13px] text-gray-600">
        <strong>Demo catalog.</strong> Prices &amp; availability for demonstration only.
      </p>
    </div>
  </section>

  <!-- Ask AI -->
  <section class="px-4 mt-4">
    <h2 class="text-base font-semibold mb-3">Ask AI</h2>
    <div class="card p-3">
      <div class="flex gap-2">
        <input id="chatInput" class="flex-1 rounded-lg border border-gray-200 px-3 py-2 text-[15px] outline-none focus:ring-2 focus:ring-pink-300"
               placeholder="e.g., Best makeup for pale skin with cool undertones" />
        <button id="chatBtn" class="btn btn-accent px-4">Ask</button>
      </div>
      <div class="mt-3 flex gap-2 flex-wrap" id="quickChips">
        <button class="chip" data-q="Everyday dewy routine">Everyday dewy routine</button>
        <button class="chip" data-q="Sensitive skin, fragrance-free skincare">Sensitive skin</button>
        <button class="chip" data-q="Wedding makeup ideas, soft glam">Wedding soft glam</button>
        <button class="chip" data-q="Makeup for hooded eyes, natural look">Hooded eyes</button>
      </div>
      <div id="aiBlock" class="mt-4 hidden">
        <div class="text-xs font-semibold text-gray-500 mb-2">AI Generated</div>
        <div id="chatResponse" class="prose prose-sm max-w-none text-[15px] leading-6"></div>
      </div>
    </div>
  </section>

  <!-- Recommendations -->
  <section class="px-4 mt-6">
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-base font-semibold">Your Recommendations</h2>
      <div class="flex gap-2">
        <input id="searchBox" class="rounded-lg border border-gray-200 px-3 py-2 text-[14px] w-44 outline-none focus:ring-2 focus:ring-pink-300" placeholder="Search products…" />
        <button id="clearBtn" class="btn btn-subtle px-3">Clear</button>
      </div>
    </div>

    <div id="results" class="grid grid-cols-2 gap-3"></div>
    <div id="emptyState" class="hidden text-center text-sm text-gray-500 mt-6">
      <p class="font-medium mb-1">No products found</p>
      <p>Try a different search or be more specific about your needs.</p>
    </div>

    <div class="sticky-bottom px-4">
      <button id="loadMore" class="btn btn-subtle w-full">Load more</button>
    </div>
  </section>

  <script>
    // --- Configuration (adjust only if you change backend routes) ---
    const CHAT_PATH = '/ask';            // working POST chat endpoint
    const API_PRODUCTS = '/api/products';// optional server endpoint
    const JSON_PRODUCTS = '/products.json'; // static JSON fallback

    // --- Small helpers ---
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function safeText(t) {
      return (t ?? '').toString();
    }

    // Accepts cents, dollars, or strings like "$24.99". Returns "$—" when missing.
    function formatPrice(value) {
      if (value === null || value === undefined || value === '') return '$—';
      if (typeof value === 'number') {
        // Heuristic: treat large integers as cents, small numbers as dollars
        if (Number.isInteger(value) && value >= 100) return '$' + (value / 100).toFixed(2);
        return '$' + value.toFixed(2);
      }
      if (typeof value === 'string') {
        const s = value.trim();
        if (s.startsWith('$')) return s;
        const n = parseFloat(s);
        if (!isFinite(n)) return '$—';
        if (!s.includes('.') && n >= 100) return '$' + (n / 100).toFixed(2);
        return '$' + n.toFixed(2);
      }
      return '$—';
    }

    function setStatus(ok) {
      const dot = $('#statusDot');
      if (!dot) return;
      dot.innerHTML = '';
      const span = document.createElement('span');
      span.className = 'h-2 w-2 rounded-full ' + (ok ? 'bg-green-500' : 'bg-gray-300');
      dot.appendChild(span);
      dot.append(' ' + (ok ? 'Online' : 'Offline'));
    }

    async function checkHealth() {
      try {
        const r = await fetch('/health');
        setStatus(r.ok);
      } catch {
        setStatus(false);
      }
    }

    // --- Core UI class ---
    class LuminousUI {
      constructor() {
        // chat
        this.chatInput = $('#chatInput');
        this.chatBtn = $('#chatBtn');
        this.chatResponse = $('#chatResponse');
        this.aiBlock = $('#aiBlock');
        this.quickChips = $('#quickChips');

        // products
        this.results = $('#results');
        this.emptyState = $('#emptyState');
        this.loadMoreBtn = $('#loadMore');
        this.searchBox = $('#searchBox');
        this.clearBtn = $('#clearBtn');

        // state
        this.query = '';
        this.offset = 0;
        this.pageSize = 8;
        this.total = 0;
        this.catalog = []; // when falling back to local JSON

        this.bind();
        this.bootstrap();
      }

      bind() {
        this.chatBtn.addEventListener('click', () => this.handleAsk());
        this.chatInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') this.handleAsk();
        });
        this.quickChips.addEventListener('click', (e) => {
          const btn = e.target.closest('[data-q]');
          if (!btn) return;
          this.chatInput.value = btn.dataset.q;
          this.handleAsk();
        });

        this.searchBox.addEventListener('input', () => {
          this.query = this.searchBox.value.trim();
          this.offset = 0;
          this.renderProducts(true);
        });

        this.clearBtn.addEventListener('click', () => {
          this.searchBox.value = '';
          this.query = '';
          this.offset = 0;
          this.renderProducts(true);
        });

        this.loadMoreBtn.addEventListener('click', () => this.renderProducts());
      }

      async bootstrap() {
        await checkHealth();
        // Try to preload catalog (helps instant rendering on first load)
        try {
          const res = await fetch(JSON_PRODUCTS + '?bust=' + Date.now());
          if (res.ok) this.catalog = await res.json();
        } catch {}
        this.renderProducts(true);
      }

      // ---- CHAT ----
      async handleAsk() {
        const msg = this.chatInput.value.trim();
        if (!msg) return;

        // UI: show skeleton answer
        this.aiBlock.classList.remove('hidden');
        this.chatResponse.innerHTML = `
          <div class="animate-pulse">
            <div class="h-4 bg-gray-200 rounded w-5/6 mb-2"></div>
            <div class="h-4 bg-gray-200 rounded w-4/6 mb-2"></div>
            <div class="h-4 bg-gray-200 rounded w-3/6"></div>
          </div>
        `;

        try {
          const r = await fetch(CHAT_PATH, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: msg })
          });
          const data = await r.json().catch(() => ({}));

          // Your backend returns { provider, model, reply }
          const text = safeText(data.reply || data.response || data.text || 'Sorry, I couldn’t find that.');
          this.chatResponse.textContent = text;
        } catch (err) {
          console.error('Chat failed', err);
          this.chatResponse.textContent = 'An error occurred while processing your request. Please try again.';
        }
      }

      // ---- PRODUCTS ----
      async fetchProductsServerSide() {
        // Try /api/products first (if implemented)
        const params = new URLSearchParams({
          q: this.query,
          offset: String(this.offset),
          limit: String(this.pageSize)
        });
        const res = await fetch(`${API_PRODUCTS}?${params.toString()}`, { method: 'GET' });
        if (!res.ok) throw new Error('api.products not available');
        const data = await res.json();
        if (!data || data.success === false) throw new Error('api.products returned error');
        // expected shape: { success:true, total, items:[...] }
        return { total: data.total ?? data.items?.length ?? 0, items: data.items ?? [] };
      }

      async fetchProductsFallback() {
        // Client-side filter from /products.json
        if (!this.catalog.length) {
          const res = await fetch(JSON_PRODUCTS + '?bust=' + Date.now());
          if (!res.ok) throw new Error('products.json missing');
          this.catalog = await res.json();
        }
        const q = this.query.toLowerCase();
        const all = this.catalog.filter(p => {
          if (!q) return true;
          const hay = [
            p.name, p.brand, p.category, p.description, p.usage, p.ingredients, p.suitableFor
          ].filter(Boolean).join(' ').toLowerCase();
          return hay.includes(q);
        });
        const items = all.slice(this.offset, this.offset + this.pageSize);
        return { total: all.length, items };
      }

      async renderProducts(reset = false) {
        if (reset) {
          this.results.innerHTML = '';
          this.offset = 0;
          this.total = 0;
        }

        // show skeletons
        const skeleton = document.createElement('div');
        skeleton.className = 'grid grid-cols-2 gap-3';
        skeleton.innerHTML = Array.from({ length: 4 }).map(() => `
          <div class="card p-3">
            <div class="h-28 rounded-lg skeleton mb-3"></div>
            <div class="h-4 w-3/4 rounded skeleton mb-2"></div>
            <div class="h-3 w-1/2 rounded skeleton mb-3"></div>
            <div class="flex justify-between">
              <div class="h-4 w-16 rounded skeleton"></div>
              <div class="h-8 w-20 rounded skeleton"></div>
            </div>
          </div>
        `).join('');
        this.results.appendChild(skeleton);

        try {
          let batch;
          try {
            batch = await this.fetchProductsServerSide();
          } catch {
            batch = await this.fetchProductsFallback();
          }

          this.total = batch.total;
          this.offset += batch.items.length;

          // render batch
          const frag = document.createDocumentFragment();
          for (const item of batch.items) frag.appendChild(this.renderCard(item));

          // swap skeleton with real nodes
          this.results.replaceChild(frag, skeleton);

          // empty state toggle
          $('#emptyState').classList.toggle('hidden', this.results.children.length > 0);

          // load more
          const hasMore = this.offset < this.total;
          this.loadMoreBtn.disabled = !hasMore;
          this.loadMoreBtn.textContent = hasMore ? 'Load more' : 'No more items';
        } catch (e) {
          console.error('renderProducts failed', e);
          // on error, clear skeleton and show empty state
          this.results.removeChild(skeleton);
          $('#emptyState').classList.remove('hidden');
          this.loadMoreBtn.disabled = true;
          this.loadMoreBtn.textContent = 'Load more';
        }
      }

      renderCard(p) {
        const name = safeText(p.name || 'Beauty product');
        const brand = safeText(p.brand || 'Salon Pro');
        const price = formatPrice(p.price);
        const was = p.was !== undefined && p.was !== null && p.was !== '' ? formatPrice(p.was) : '';
        const badge = p.category ? `<span class="text-[10px] px-2 py-1 bg-pink-50 text-pink-600 rounded-full">${safeText(p.category)}</span>` : '';

        const card = document.createElement('div');
        card.className = 'card overflow-hidden';

        // image or placeholder
        const imgSrc = p.image || p.img || '';
        const imgBlock = imgSrc
          ? `<img src="${imgSrc}" alt="${name}" class="w-full h-36 object-cover">`
          : `<div class="h-36 bg-gray-100 flex items-center justify-center text-gray-400 text-sm">No image</div>`;

        card.innerHTML = `
          ${imgBlock}
          <div class="p-3">
            <div class="flex items-start justify-between gap-2">
              <div>
                <div class="text-[11px] text-gray-500">${brand}</div>
                <div class="text-[15px] font-semibold leading-5">${name}</div>
              </div>
              ${badge}
            </div>
            <div class="mt-2 flex items-center justify-between">
              <div class="text-[15px] font-bold">${price}</div>
              <div class="text-xs text-gray-400 line-through">${was}</div>
            </div>
            <div class="mt-3 flex gap-2">
              <button class="btn btn-subtle flex-1" data-action="details">Details</button>
              <button class="btn btn-accent flex-1" data-action="add">Add</button>
            </div>
          </div>
        `;

        card.querySelector('[data-action="details"]').addEventListener('click', () => {
          const bits = [];
          if (p.description) bits.push(p.description);
          if (p.usage) bits.push('Usage: ' + p.usage);
          if (p.ingredients) bits.push('Key ingredients: ' + p.ingredients);
          if (p.suitableFor) bits.push('Perfect for: ' + p.suitableFor);
          alert(`${name}\n\n${bits.join('\n\n') || 'Professional salon product designed for optimal results.'}`);
        });

        card.querySelector('[data-action="add"]').addEventListener('click', () => {
          alert('Added to bag (demo)');
        });

        return card;
      }
    }

    // Wire up
    document.addEventListener('DOMContentLoaded', () => {
      window.app = new LuminousUI();
    });
  </script>
</body>
</html>
