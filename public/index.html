<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Salon Consultant - Luminous</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#111;color:#333;line-height:1.4;overflow-x:hidden}
    .container{max-width:414px;margin:0 auto;background:#f8f8f8;min-height:100vh;padding-bottom:100px}
    .header{background:linear-gradient(135deg,#B8860B,#DAA520);color:#fff;padding:24px 16px;text-align:center;position:sticky;top:0;z-index:100;box-shadow:0 2px 20px rgba(0,0,0,.15)}
    .header h1{font-size:20px;font-weight:800;letter-spacing:.5px;margin-bottom:4px}
    .header .tagline{font-size:12px;opacity:.9}
    .main{padding:20px 16px}
    .welcome-section{background:#fff;border-radius:16px;padding:20px;margin-bottom:20px;border:1px solid #eee;box-shadow:0 4px 12px rgba(0,0,0,.05);text-align:center}
    .welcome-title{font-size:18px;font-weight:700;color:#222;margin-bottom:8px}
    .welcome-text{font-size:14px;color:#666;margin-bottom:16px;line-height:1.5}
    .quick-examples{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:16px}
    .example-btn{background:#f8f9fa;border:1px solid #e9ecef;border-radius:10px;padding:12px 8px;font-size:11px;text-align:center;cursor:pointer;color:#495057;font-weight:500;transition:all .2s ease}
    .example-btn:hover{border-color:#B8860B;color:#B8860B;transform:translateY(-1px)}
    .client-profile{background:#fff;border-radius:16px;padding:18px;margin-bottom:20px;border:1px solid #eee;box-shadow:0 4px 12px rgba(0,0,0,.05)}
    .profile-title{font-weight:700;font-size:15px;color:#222;margin-bottom:14px;text-align:center}
    .profile-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .profile-select{padding:12px;border:1px solid #ddd;border-radius:10px;font-size:13px;background:#fff;outline:none;color:#495057}
    .profile-select:focus{border-color:#B8860B;box-shadow:0 0 0 2px rgba(184,134,11,.1)}
    .chat-section{margin-bottom:24px}
    .chat-input-container{background:#fff;border-radius:16px;padding:6px;border:2px solid #e9ecef;box-shadow:0 4px 12px rgba(0,0,0,.05);display:flex;align-items:center;gap:8px}
    .chat-input-container:focus-within{border-color:#B8860B;box-shadow:0 4px 20px rgba(184,134,11,.15)}
    .chat-input{flex:1;padding:16px;border:none;font-size:15px;outline:none;background:transparent;color:#333}
    .chat-input::placeholder{color:#999}
    .chat-btn{padding:12px 16px;background:linear-gradient(135deg,#B8860B,#DAA520);color:#fff;border:none;border-radius:12px;font-weight:700;cursor:pointer;font-size:14px;min-width:60px;transition:all .2s ease}
    .chat-btn:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 4px 12px rgba(184,134,11,.3)}
    .chat-btn:disabled{opacity:.6;cursor:not-allowed}
    .ai-status{background:linear-gradient(135deg,#e7f3ff,#f0f8ff);color:#06c;padding:12px 16px;border-radius:12px;font-size:13px;margin:16px 0;text-align:center;border:1px solid #cce7ff;display:none;animation:pulse 2s infinite}
    .ai-status.active{display:block}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
    .chat-response{background:#fff;border-radius:16px;padding:18px;border:1px solid #eee;box-shadow:0 4px 12px rgba(0,0,0,.05);font-size:14px;line-height:1.6;color:#333;margin-bottom:20px}
    .products-section{margin-top:24px}
    .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .section-title{font-size:17px;font-weight:700;color:#222}
    .ai-badge{background:#e7f3ff;color:#06c;padding:4px 10px;border-radius:20px;font-size:10px;font-weight:600;border:1px solid #cce7ff}
    .products-grid{display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:20px}
    .product-card{background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.08);border:1px solid #f0f0f0;transition:all .3s ease}
    .product-card:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,.12)}
    .product-card.ai-generated{border-left:4px solid #B8860B}
    .product-content{display:grid;grid-template-columns:100px 1fr;gap:16px}
    .product-image{width:100px;height:100px;border-radius:12px;object-fit:cover;margin:16px 0 16px 16px}
    .product-image-placeholder{width:100px;height:100px;background:linear-gradient(135deg,#f0f0f0,#e8e8e8);display:flex;align-items:center;justify-content:center;color:#999;font-size:24px;margin:16px 0 16px 16px;border-radius:12px}
    .product-info{padding:16px 16px 16px 0}
    .product-name{font-weight:700;font-size:15px;color:#222;margin-bottom:4px;line-height:1.3}
    .product-meta{font-size:12px;color:#666;margin-bottom:8px}
    .product-description{font-size:12px;color:#555;line-height:1.4;margin-bottom:10px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .product-benefits{margin-bottom:10px;display:none}
    .product-benefits.visible{display:block}
    .benefit-tag{display:inline-block;background:#f0f8ff;color:#06c;padding:2px 6px;border-radius:4px;font-size:10px;margin:1px;border:1px solid #cce7ff}
    .product-footer{display:flex;justify-content:space-between;align-items:center}
    .product-price{font-weight:700;color:#B8860B;font-size:16px}
    .product-actions{display:flex;gap:8px}
    .details-btn{background:#f8f9fa;color:#666;border:1px solid #ddd;border-radius:8px;padding:6px 10px;font-size:11px;font-weight:600;cursor:pointer}
    .add-btn{background:linear-gradient(135deg,#28a745,#20c997);color:#fff;border:none;border-radius:8px;padding:6px 12px;font-size:11px;font-weight:600;cursor:pointer}
    .load-more{text-align:center;margin:24px 0}
    .load-more-btn{background:linear-gradient(135deg,#B8860B,#DAA520);color:#fff;border:none;border-radius:16px;padding:14px 18px;font-weight:600;cursor:pointer;font-size:14px}
    .home-btn{background:#f8f9fa;color:#666;border:1px solid #ddd;border-radius:16px;padding:14px 18px;font-weight:600;cursor:pointer;font-size:14px;margin-left:8px}
    .status{text-align:center;color:#666;font-size:13px;margin-bottom:16px;padding:12px;background:#fff;border-radius:12px}
    .error{background:#fee;color:#c33;padding:16px;border-radius:12px;margin:16px 0;font-size:13px;border:1px solid #fcc}
    .empty-state{text-align:center;padding:40px 20px;color:#666}
    .empty-state h3{font-size:16px;margin-bottom:8px;color:#333}
    .empty-state p{font-size:13px;line-height:1.5}
    @media (max-width:380px){.container{max-width:100%}.profile-grid{grid-template-columns:1fr}.quick-examples{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>AI Salon Consultant</h1>
      <div class="tagline">Your personal beauty expert powered by AI</div>
    </header>

    <main class="main">
      <section class="welcome-section">
        <div class="welcome-title">Welcome to Your Personal Salon</div>
        <div class="welcome-text">Tell me about your hair, skin, or beauty goals and I'll recommend the perfect professional products just for you.</div>
        <div class="quick-examples">
          <button class="example-btn" onclick="quickAsk('repair damaged curly hair')">Repair Damage</button>
          <button class="example-btn" onclick="quickAsk('anti-aging skincare routine')">Anti-Aging</button>
          <button class="example-btn" onclick="quickAsk('accessories')">Accessories</button>
          <button class="example-btn" onclick="quickAsk('acne-prone sensitive skin')">Clear Skin</button>
        </div>
      </section>

      <section class="client-profile">
        <div class="profile-title">Tell Me About Yourself</div>
        <div class="profile-grid">
          <select class="profile-select" id="hairType">
            <option value="">Hair Type</option>
            <option value="straight">Straight</option>
            <option value="wavy">Wavy</option>
            <option value="curly">Curly</option>
            <option value="coily">Coily/Kinky</option>
          </select>
          <select class="profile-select" id="skinType">
            <option value="">Skin Type</option>
            <option value="oily">Oily</option>
            <option value="dry">Dry</option>
            <option value="combination">Combination</option>
            <option value="sensitive">Sensitive</option>
          </select>
          <select class="profile-select" id="concerns">
            <option value="">Main Concerns</option>
            <option value="damage">Damage/Breakage</option>
            <option value="frizz">Frizz Control</option>
            <option value="volume">Volume</option>
            <option value="color">Color Protection</option>
            <option value="aging">Anti-Aging</option>
            <option value="acne">Acne</option>
            <option value="dryness">Dryness</option>
          </select>
          <select class="profile-select" id="budget">
            <option value="">Budget Range</option>
            <option value="budget">Budget ($10-30)</option>
            <option value="mid">Mid-Range ($30-60)</option>
            <option value="luxury">Luxury ($60+)</option>
          </select>
        </div>
      </section>

      <section class="chat-section">
        <div class="chat-input-container">
          <input id="chatInput" class="chat-input" placeholder="Ask me anything... 'I need products for dry, frizzy hair'" autocomplete="off">
          <button id="chatBtn" class="chat-btn">Ask AI</button>
        </div>

        <div id="aiStatus" class="ai-status">AI is generating personalized recommendations...</div>

        <div id="chatResponse" class="chat-response">
          Hi! I'm your AI salon consultant. Tell me about your hair, skin, or beauty concerns, and I'll recommend the perfect professional products tailored specifically for you.
        </div>
      </section>

      <section id="productsSection" class="products-section" style="display:none;">
        <div class="section-header">
          <div class="section-title">Your Recommendations</div>
          <div class="ai-badge">AI Generated</div>
        </div>

        <div id="status" class="status"></div>
        <div id="productsGrid" class="products-grid"></div>

        <div id="loadMoreSection" class="load-more" style="display:none;">
          <button id="loadMoreBtn" class="load-more-btn">Show More Products</button>
          <button class="home-btn" onclick="location.reload()">Start New Search</button>
        </div>
      </section>
    </main>
  </div>

<script>
(() => {
  const qs = (sel) => document.querySelector(sel);

  async function fetchJSON(url) {
    const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
    if (!res.ok) throw new Error(`${url} -> HTTP ${res.status}`);
    return res.json();
  }

  function toCentsMaybe(val) {
    if (typeof val === 'number' && Number.isFinite(val)) return Math.round(val * 100);
    if (typeof val === 'string') {
      const num = parseFloat(val.replace(/[$,]/g, ''));
      if (Number.isFinite(num)) return Math.round(num * 100);
    }
    return NaN;
  }

  function normalizeProduct(p) {
    let cents = NaN;
    if (typeof p.priceCents === 'number') cents = p.priceCents;
    else if (typeof p.priceCents === 'string') {
      const n = parseInt(p.priceCents.replace(/\D/g, ''), 10);
      if (Number.isFinite(n)) cents = n;
    } else if (typeof p.price === 'number' || typeof p.price === 'string') {
      cents = toCentsMaybe(p.price);
    }

    const desc = p.description && String(p.description).trim()
      ? String(p.description).trim()
      : `Professional ${String(p.category || 'beauty').toLowerCase()} ‚Äî ${String(p.name || 'product')}.`;

    return {
      id: p.id || '',
      name: p.name || 'Product',
      brand: p.brand || '‚Äî',
      category: p.category || '‚Äî',
      priceCents: Number.isFinite(cents) ? cents : NaN,
      image: p.image || '/images/placeholder.jpg',
      description: desc,
      usage: p.usage || '',
      ingredients: p.ingredients || '',
      benefits: Array.isArray(p.benefits) ? p.benefits : []
    };
  }

  function formatCents(cents) {
    return (Number.isFinite(cents) && cents > 0) ? ('$' + (cents / 100).toFixed(2)) : '$‚Äî';
  }

  function expandQueryTokens(q) {
    const t = (q || '').toLowerCase().split(/\s+/).filter(Boolean);
    // A few helpful expansions so ‚Äúaccessories‚Äù isn‚Äôt a dead end
    if (t.includes('accessories')) {
      t.push('brush','comb','tweezer','clip','clipper','nail','bobby','shower','cap','lipstick','eyeliner','liner');
    }
    return t;
  }

  function matchesStrictAll(p, tokens) {
    if (!tokens.length) return true;
    const hay = `${p.name} ${p.brand} ${p.category} ${p.description}`.toLowerCase();
    return tokens.every(tok => hay.includes(tok));
  }

  function matchesAny(p, tokens) {
    if (!tokens.length) return true;
    const hay = `${p.name} ${p.brand} ${p.category} ${p.description}`.toLowerCase();
    return tokens.some(tok => hay.includes(tok));
  }

  function uniqById(arr) {
    const seen = new Set();
    const out = [];
    for (const x of arr) {
      if (!x || !x.id) continue;
      if (seen.has(x.id)) continue;
      seen.add(x.id);
      out.push(x);
    }
    return out;
  }

  async function fetchStaticCatalog() {
    const STATIC_URLS = ['/data/products.json', '/products.json', '/public/data/products.json'];
    for (const url of STATIC_URLS) {
      try {
        const raw = await fetchJSON(url);
        const arr = Array.isArray(raw) ? raw : (Array.isArray(raw.items) ? raw.items : []);
        console.log('[catalog] loaded', url, 'count=', arr.length);
        return arr.map(normalizeProduct);
      } catch (e) {
        console.warn('[catalog] not at', url, e.message);
      }
    }
    return [];
  }

  async function fetchMerged({ q, offset, limit, profile }) {
    let apiItems = [];
    let staticItems = [];

    // API (best effort)
    try {
      const params = new URLSearchParams({
        q: q || '',
        offset: offset,
        limit: limit,
        ...profile
      });
      const apiData = await fetchJSON(`/api/products?${params.toString()}`);
      apiItems = Array.isArray(apiData.items) ? apiData.items.map(normalizeProduct) : [];
      console.log('[api] items=', apiItems.length);
    } catch (e) {
      console.warn('[api] failed:', e.message);
    }

    // Static
    staticItems = await fetchStaticCatalog();

    // Merge, filter
    const base = uniqById([...apiItems, ...staticItems]);
    const tokens = expandQueryTokens(q);
    let filtered = base.filter(p => matchesStrictAll(p, tokens));

    // Fallback: any-word match
    if (!filtered.length) filtered = base.filter(p => matchesAny(p, tokens));
    // Final fallback: show top items so we never render ‚ÄúNo products found‚Äù
    if (!filtered.length && base.length) filtered = base.slice();

    const total = filtered.length;
    const slice = filtered.slice(offset, offset + limit);
    const aiGenerated = apiItems.length > 0;
    return { items: slice, total, aiGenerated, query: q, hadFallback: (slice.length && slice.length < base.length && !matchesStrictAll(slice[0]||{}, tokens)) };
  }

  class UnifiedSalonAI {
    constructor() {
      this.currentQuery = '';
      this.currentOffset = 0;
      this.totalProducts = 0;
      this.pageSize = 25;
      this.isLoading = false;

      this.chatInput = qs('#chatInput');
      this.chatBtn = qs('#chatBtn');
      this.chatResponse = qs('#chatResponse');
      this.aiStatus = qs('#aiStatus');
      this.status = qs('#status');
      this.grid = qs('#productsGrid');
      this.loadMoreSection = qs('#loadMoreSection');
      this.productsSection = qs('#productsSection');

      this.hairType = qs('#hairType');
      this.skinType = qs('#skinType');
      this.concerns = qs('#concerns');
      this.budget = qs('#budget');

      this.bind();
      this.welcome();
    }

    bind() {
      this.chatBtn?.addEventListener('click', () => this.handleAsk());
      this.chatInput?.addEventListener('keypress', e => {
        if (e.key === 'Enter' && !this.isLoading) this.handleAsk();
      });
      this.loadMoreSection?.addEventListener('click', e => {
        if (e.target.closest('#loadMoreBtn')) this.loadMore();
      });
      [this.hairType,this.skinType,this.concerns,this.budget].forEach(s => {
        s?.addEventListener('change', () => this.currentQuery && this.search(this.currentQuery, true));
      });
    }

    welcome() {
      if (!this.chatResponse) return;
      this.chatResponse.innerHTML = `
        <div style="text-align:center;color:#666;">
          <h3 style="color:#333;margin-bottom:12px;">Welcome to Your AI Salon</h3>
          <p style="margin-bottom:16px;">I'm here to give you personalized product recommendations.</p>
          <p style="font-size:13px;"><strong>Try:</strong></p>
          <ul style="text-align:left;font-size:12px;margin-top:8px;padding-left:20px;">
            <li>"shampoo"</li>
            <li>"serum"</li>
            <li>"bond repair"</li>
            <li>"accessories"</li>
          </ul>
        </div>`;
    }

    profile() {
      return {
        hairType: this.hairType?.value || '',
        skinType: this.skinType?.value || '',
        concerns: this.concerns?.value || '',
        budget: this.budget?.value || ''
      };
    }

    async handleAsk() {
      const message = (this.chatInput?.value || '').trim();
      if (!message || this.isLoading) return;

      this.isLoading = true;
      if (this.chatBtn) { this.chatBtn.disabled = true; this.chatBtn.textContent = '...'; }
      this.aiStatus?.classList.add('active');
      if (this.productsSection) this.productsSection.style.display = 'block';

      this.safeChat(message);
      this.currentQuery = message;
      await this.search(message, true);

      if (this.chatInput) this.chatInput.value = '';
      this.isLoading = false;
      if (this.chatBtn) { this.chatBtn.disabled = false; this.chatBtn.textContent = 'Ask AI'; }
      this.aiStatus?.classList.remove('active');
    }

    async safeChat(message) {
      try {
        const res = await fetch('/api/chat', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ message }) });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        this.renderChat(data?.response);
      } catch {
        this.renderChat(null);
      }
    }

    renderChat(text) {
      if (!this.chatResponse) return;
      this.chatResponse.innerHTML = `
        <div style="border-left:4px solid #B8860B;padding-left:16px;">
          <h4 style="color:#B8860B;margin-bottom:8px;font-size:14px;">AI Consultation</h4>
          <p style="line-height:1.6;">${text || 'Let me help you find the perfect products for your needs.'}</p>
        </div>`;
    }

    async search(query, reset=false) {
      if (reset) { this.currentOffset = 0; this.grid && (this.grid.innerHTML=''); }

      try {
        if (this.status) this.status.textContent = 'Finding matching products...';

        const { items, total, aiGenerated, query: echoed } =
          await fetchMerged({ q: query, offset: this.currentOffset, limit: this.pageSize, profile: this.profile() });

        if (!items.length && reset) {
          this.empty();
          this.totalProducts = 0;
          this.updateMore(false);
          return;
        }

        items.forEach(p => this.grid.appendChild(this.card(p, aiGenerated)));
        this.currentOffset += items.length;
        this.totalProducts = total;

        const type = aiGenerated ? 'AI recommendations' : 'products';
        if (this.status) {
          this.status.textContent = `Showing ${this.currentOffset} of ${Math.min(total, 100)} ${type} for "${echoed || query}"`;
        }

        this.updateMore(this.currentOffset < total);
      } catch (err) {
        console.error('Product search failed:', err);
        if (this.status) this.status.innerHTML = `<div class="error">Error: ${err.message}</div>`;
      }
    }

    card(p, ai=false) {
      const div = document.createElement('div');
      div.className = `product-card${ai ? ' ai-generated' : ''}`;
      const price = formatCents(p.priceCents);
      const benefits = p.benefits?.length ? `<div class="product-benefits">${p.benefits.map(b=>`<span class="benefit-tag">${b}</span>`).join('')}</div>` : '';
      div.innerHTML = `
        <div class="product-content">
          <img class="product-image" loading="lazy" referrerpolicy="no-referrer"
               src="${(p.image||'').replace(/"/g,'&quot;')}"
               alt="${(p.name||'Product').replace(/"/g,'&quot;')}"
               onerror="this.outerHTML='<div class=\\'product-image-placeholder\\'>üíÜ‚Äç‚ôÄÔ∏è</div>'">
          <div class="product-info">
            <div class="product-name">${p.name}</div>
            <div class="product-meta">${p.brand} ‚Ä¢ ${p.category}</div>
            ${p.description ? `<div class="product-description">${p.description}</div>` : ''}
            ${benefits}
            <div class="product-footer">
              <div class="product-price">${price}</div>
              <div class="product-actions">
                ${p.description ? '<button class="details-btn">Details</button>' : ''}
                <button class="add-btn" data-id="${p.id}">Add to Cart</button>
              </div>
            </div>
          </div>
        </div>`;
      div.querySelector('.details-btn')?.addEventListener('click', () => this.details(p));
      div.querySelector('.add-btn')?.addEventListener('click', () => alert(`Added "${p.name}" to cart (${formatCents(p.priceCents)})`));
      return div;
    }

    details(p) {
      const lines = [];
      if (p.usage) lines.push(`Usage: ${p.usage}`);
      if (p.ingredients) lines.push(`Key Ingredients: ${p.ingredients}`);
      if (p.benefits?.length) lines.push(`Benefits: ${p.benefits.join(', ')}`);
      alert(`${p.name}\n\n${lines.join('\n\n') || p.description || 'Professional salon product.'}`);
    }

    empty() {
      if (!this.grid) return;
      this.grid.innerHTML = `
        <div class="empty-state">
          <h3>No products found</h3>
          <p>Try a different search or be more specific about your needs.</p>
        </div>`;
    }

    updateMore(hasMore) {
      const box = this.loadMoreSection;
      if (!box) return;
      if (hasMore) {
        box.style.display = 'block';
        box.innerHTML = `
          <button class="load-more-btn" id="loadMoreBtn">
            Show More Products (${this.currentOffset}/${this.totalProducts})
          </button>
          <button class="home-btn" onclick="location.reload()">Start New Search</button>`;
      } else if (this.totalProducts > 0) {
        box.style.display = 'block';
        box.innerHTML = `<button class="home-btn" onclick="location.reload()">Start New Search</button>`;
      } else {
        box.style.display = 'none';
      }
    }

    loadMore() { this.search(this.currentQuery, false); }
  }

  window.quickAsk = (text) => {
    const app = window.salonAI;
    if (!app) return;
    app.chatInput.value = text;
    app.handleAsk();
  };

  window.addEventListener('DOMContentLoaded', () => {
    window.salonAI = new UnifiedSalonAI();
  });
})();
</script>
</body>
</html>
