<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Salon Consultant - Luminous</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#111;color:#333;line-height:1.4;overflow-x:hidden}
    .container{max-width:414px;margin:0 auto;background:#f8f8f8;min-height:100vh;padding-bottom:100px}
    .header{background:linear-gradient(135deg,#B8860B,#DAA520);color:#fff;padding:24px 16px;text-align:center;position:sticky;top:0;z-index:100;box-shadow:0 2px 20px rgba(0,0,0,.15)}
    .header h1{font-size:20px;font-weight:800;letter-spacing:.5px;margin-bottom:4px}
    .header .tagline{font-size:12px;opacity:.9}
    .main{padding:20px 16px}
    .welcome-section{background:#fff;border-radius:16px;padding:20px;margin-bottom:20px;border:1px solid #eee;box-shadow:0 4px 12px rgba(0,0,0,.05);text-align:center}
    .welcome-title{font-size:18px;font-weight:700;color:#222;margin-bottom:8px}
    .welcome-text{font-size:14px;color:#666;margin-bottom:16px;line-height:1.5}
    .quick-examples{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:16px}
    .example-btn{background:#f8f9fa;border:1px solid #e9ecef;border-radius:10px;padding:12px 8px;font-size:11px;text-align:center;cursor:pointer;color:#495057;font-weight:500;transition:all .2s ease}
    .example-btn:hover{border-color:#B8860B;color:#B8860B;transform:translateY(-1px)}
    .client-profile{display:none;}
    .chat-section{margin-bottom:24px}
    .chat-input-container{background:#fff;border-radius:16px;padding:6px;border:2px solid #e9ecef;box-shadow:0 4px 12px rgba(0,0,0,.05);display:flex;align-items:center;gap:8px}
    .chat-input-container:focus-within{border-color:#B8860B;box-shadow:0 4px 20px rgba(184,134,11,.15)}
    .chat-input{flex:1;padding:16px;border:none;font-size:15px;outline:none;background:transparent;color:#333}
    .chat-input::placeholder{color:#999}
    .chat-btn{padding:12px 16px;background:linear-gradient(135deg,#B8860B,#DAA520);color:#fff;border:none;border-radius:12px;font-weight:700;cursor:pointer;font-size:14px;min-width:60px;transition:all .2s ease}
    .chat-btn:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 4px 12px rgba(184,134,11,.3)}
    .chat-btn:disabled{opacity:.6;cursor:not-allowed}
    .ai-status{background:linear-gradient(135deg,#e7f3ff,#f0f8ff);color:#06c;padding:12px 16px;border-radius:12px;font-size:13px;margin:16px 0;text-align:center;border:1px solid #cce7ff;display:none;animation:pulse 2s infinite}
    .ai-status.active{display:block}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
    .chat-response{background:#fff;border-radius:16px;padding:18px;border:1px solid #eee;box-shadow:0 4px 12px rgba(0,0,0,.05);font-size:14px;line-height:1.6;color:#333;margin-bottom:20px}
    .chat-paragraph { white-space: pre-wrap; margin-bottom: 1em; }
    .products-section{margin-top:24px}
    .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .section-title{font-size:17px;font-weight:700;color:#222}
    .ai-badge{background:#e7f3ff;color:#06c;padding:4px 10px;border-radius:20px;font-size:10px;font-weight:600;border:1px solid #cce7ff}
    .products-grid{display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:20px}
    .product-card{background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.08);border:1px solid #f0f0f0;transition:all .3s ease}
    .product-card:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,.12)}
    .product-card.ai-generated{border-left:4px solid #B8860B}
    .product-content{display:grid;grid-template-columns:100px 1fr;gap:16px}
    .product-image{width:100px;height:100px;border-radius:12px;object-fit:cover;margin:16px 0 16px 16px}
    .product-image-placeholder{width:100px;height:100px;background:linear-gradient(135deg,#f0f0f0,#e8e8e8);display:flex;align-items:center;justify-content:center;color:#999;font-size:24px;margin:16px 0 16px 16px;border-radius:12px}
    .product-info{padding:16px 16px 16px 0}
    .product-name{font-weight:700;font-size:15px;color:#222;margin-bottom:4px;line-height:1.3}
    .product-meta{font-size:12px;color:#666;margin-bottom:8px}
    .product-description{font-size:12px;color:#555;line-height:1.4;margin-bottom:10px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .product-benefits{margin-bottom:10px;display:none}
    .product-benefits.visible{display:block}
    .benefit-tag{display:inline-block;background:#f0f8ff;color:#06c;padding:2px 6px;border-radius:4px;font-size:10px;margin:1px;border:1px solid #cce7ff}
    .product-footer{display:flex;justify-content:space-between;align-items:center}
    .product-price{font-weight:700;color:#B8860B;font-size:16px}
    .product-actions{display:flex;gap:8px}
    .details-btn{background:#f8f9fa;color:#666;border:1px solid #ddd;border-radius:8px;padding:6px 10px;font-size:11px;font-weight:600;cursor:pointer}
    .add-btn{background:linear-gradient(135deg,#28a745,#20c997);color:#fff;border:none;border-radius:8px;padding:6px 12px;font-size:11px;font-weight:600;cursor:pointer}
    .load-more{text-align:center;margin:24px 0}
    .load-more-btn{background:linear-gradient(135deg,#B8860B,#DAA520);color:#fff;border:none;border-radius:16px;padding:14px 18px;font-weight:600;cursor:pointer;font-size:14px}
    .home-btn{background:#f8f9fa;color:#666;border:1px solid #ddd;border-radius:16px;padding:14px 18px;font-weight:600;cursor:pointer;font-size:14px;margin-left:8px}
    .status{text-align:center;color:#666;font-size:13px;margin-bottom:16px;padding:12px;background:#fff;border-radius:12px}
    .error{background:#fee;color:#c33;padding:16px;border-radius:12px;margin:16px 0;font-size:13px;border:1px solid #fcc}
    .empty-state{text-align:center;padding:40px 20px;color:#666}
    .empty-state h3{font-size:16px;margin-bottom:8px;color:#333}
    .empty-state p{font-size:13px;line-height:1.5}
    .footer-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #fff;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 10px 0;
      border-top: 1px solid #eee;
      box-shadow: 0 -2px 10px rgba(0,0,0,.05);
    }
    .footer-nav a {
      text-decoration: none;
      color: #666;
      font-size: 11px;
      font-weight: 600;
      text-align: center;
    }
    .footer-nav svg {
        width: 20px;
        height: 20px;
        margin-bottom: 4px;
    }
    @media (max-width:380px){.container{max-width:100%}.quick-examples{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>AI Salon Consultant</h1>
      <div class="tagline">Your personal beauty expert powered by AI</div>
    </header>

    <main class="main">
      <section class="welcome-section">
        <div class="welcome-title">Welcome to Your Personal Salon</div>
        <div class="welcome-text">Tell me about your hair, skin, or beauty goals and I'll recommend the perfect professional products just for you.</div>
        <div class="quick-examples">
          <button class="example-btn" data-query="repair damaged curly hair">Repair Damage</button>
          <button class="example-btn" data-query="anti-aging skincare routine">Anti-Aging</button>
          <button class="example-btn" data-query="accessories">Accessories</button>
          <button class="example-btn" data-query="acne-prone sensitive skin">Clear Skin</button>
        </div>
      </section>

      <section class="chat-section">
        <div class="chat-input-container">
          <input id="chatInput" class="chat-input" placeholder="Ask me anything... 'I need products for dry, frizzy hair'" autocomplete="off">
          <button id="chatBtn" class="chat-btn">Ask AI</button>
        </div>

        <div id="aiStatus" class="ai-status">AI is generating personalized recommendations...</div>

        <div id="chatResponse" class="chat-response">
          Hi! I'm your AI salon consultant. Tell me about your hair, skin, or beauty concerns, and I'll recommend the perfect professional products tailored specifically for you.
        </div>
      </section>

      <section id="productsSection" class="products-section" style="display:none;">
        <div class="section-header">
          <div class="section-title">Your Recommendations</div>
          <div class="ai-badge">AI Generated</div>
        </div>
        <div id="status" class="status"></div>
        <div id="productsGrid" class="products-grid"></div>
        <div id="loadMoreSection" class="load-more" style="display:none;">
          <button id="homeBtn" class="home-btn">Start New Search</button>
        </div>
      </section>
    </main>
    <div class="footer-nav">
        <a href="#" id="homeNavBtn">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
              <path d="M11.47 3.829a1.5 1.5 0 0 1 1.06 0l7.5 4.33a1.5 1.5 0 0 1 .75 1.296v9.141a1.5 1.5 0 0 1-.75 1.296l-7.5 4.33a1.5 1.5 0 0 1-1.06 0l-7.5-4.33a1.5 1.5 0 0 1-.75-1.296V9.455a1.5 1.5 0 0 1 .75-1.296l7.5-4.33Z" stroke="currentColor" stroke-width="1.5"/>
            </svg>
            Home
        </a>
        <a href="#" id="profileNavBtn">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 1 1 9 0a4.5 4.5 0 0 1-9 0Zm-.75 9a.75.75 0 0 0-.75.75v2.25c0 .414.336.75.75.75h1.5a.75.75 0 0 0 .75-.75v-2.25a.75.75 0 0 0-.75-.75h-1.5Zm12.75 0a.75.75 0 0 0-.75.75v2.25a.75.75 0 0 0 .75.75h1.5a.75.75 0 0 0 .75-.75v-2.25a.75.75 0 0 0-.75-.75h-1.5ZM4.783 14.283a.75.75 0 0 1 1.061 0l.974.975a.75.75 0 1 1-1.06 1.06l-.975-.975a.75.75 0 0 1 0-1.06ZM19.217 14.283a.75.75 0 0 1 0 1.06l-.974.975a.75.75 0 0 1-1.06-1.06l.975-.975a.75.75 0 0 1 1.06 0ZM7.87 18.75a.75.75 0 0 1-.75-.75V15a.75.75 0 0 1 1.5 0v3a.75.75 0 0 1-.75.75ZM15.75 18.75a.75.75 0 0 1-.75-.75V15a.75.75 0 0 1 1.5 0v3a.75.75 0 0 1-.75.75ZM9.75 18.75a.75.75 0 0 1-.75-.75V15a.75.75 0 0 1 1.5 0v3a.75.75 0 0 1-.75.75ZM13.847 14.847a.75.75 0 1 1 1.06-1.06l.975.975a.75.75 0 0 1-1.06 1.06l-.975-.975ZM18.5 17.25a.75.75 0 0 1-.75.75H6.25a.75.75 0 0 1 0-1.5h11.5a.75.75 0 0 1 .75.75Z" clip-rule="evenodd" stroke="currentColor" stroke-width="1.5"/>
              </svg>
            Profile
        </a>
        <a href="#" id="appointmentsNavBtn">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0a9 9 0 0 1 18 0Z" />
            </svg>
            Appointments
        </a>
        <a href="#" id="basketNavBtn">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 1 0-7.5 0v4.5m11.356-1.993 1.264.063c.31.016.556.262.572.572l.063 1.264v3.172c-.007.604-.15.82-.676 1.15l-1.085.698a.75.75 0 0 1-.735-1.285l1.085-.698c-.427.275-.524-.46-.524-.555V10.59m-11.356 1.993-1.264.063a.572.572 0 0 1-.572-.572l-.063-1.264v-3.172c.007-.604.15-.82.676-1.15l1.085-.698a.75.75 0 0 1 .735 1.285l-1.085.698c-.427.275-.524.46-.524.555V10.59m1.264.063c.31.016.556.262.572.572l.063 1.264v3.172c-.007.604-.15.82-.676 1.15l-1.085.698a.75.75 0 0 1-.735 1.285l1.085-.698c-.427.275-.524.46-.524.555V10.59" />
            </svg>
            Basket
        </a>
    </div>
  </div>

<script>
(() => {
  const qs = (sel) => document.querySelector(sel);
  const qsa = (sel) => document.querySelectorAll(sel);

  async function fetchJSON(url) {
    const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
    if (!res.ok) throw new Error(`${url} -> HTTP ${res.status}`);
    return res.json();
  }

  function toCentsMaybe(val) {
    if (typeof val === 'number' && Number.isFinite(val)) return Math.round(val * 100);
    if (typeof val === 'string') {
      const num = parseFloat(val.replace(/[$,]/g, ''));
      if (Number.isFinite(num)) return Math.round(num * 100);
    }
    return NaN;
  }

  function normalizeProduct(p) {
    let cents = NaN;
    if (typeof p.priceCents === 'number') cents = p.priceCents;
    else if (typeof p.priceCents === 'string') {
      const n = parseInt(p.priceCents.replace(/\D/g, ''), 10);
      if (Number.isFinite(n)) cents = n;
    } else if (typeof p.price === 'number' || typeof p.price === 'string') {
      cents = toCentsMaybe(p.price);
    }

    const desc = p.description && String(p.description).trim()
      ? String(p.description).trim()
      : `Professional ${String(p.category || 'beauty').toLowerCase()} — ${String(p.name || 'product')}.`;

    return {
      id: p.id || '',
      name: p.name || 'Product',
      brand: p.brand || '—',
      category: p.category || '—',
      priceCents: Number.isFinite(cents) ? cents : NaN,
      image: p.image || '/images/placeholder.jpg',
      description: desc,
      usage: p.usage || '',
      instructions: p.instructions || '',
      benefits: Array.isArray(p.benefits) ? p.benefits : []
    };
  }

  function formatCents(cents) {
    return (Number.isFinite(cents) && cents > 0) ? ('$' + (cents / 100).toFixed(2)) : '$—';
  }

  async function fetchUnifiedService(message) {
    const response = await fetch('/api/unified-service', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: message })
    });
    return await response.json();
  }

  class UnifiedSalonAI {
    constructor() {
      this.currentQuery = '';
      this.isLoading = false;

      this.chatInput = qs('#chatInput');
      this.chatBtn = qs('#chatBtn');
      this.chatResponse = qs('#chatResponse');
      this.aiStatus = qs('#aiStatus');
      this.status = qs('#status');
      this.grid = qs('#productsGrid');
      this.productsSection = qs('#productsSection');
      this.welcomeSection = qs('.welcome-section');
      
      this.homeNavBtn = qs('#homeNavBtn');
      this.profileNavBtn = qs('#profileNavBtn');
      this.appointmentsNavBtn = qs('#appointmentsNavBtn');
      this.basketNavBtn = qs('#basketNavBtn');
      this.exampleBtns = qsa('.example-btn');

      this.bind();
      this.welcome();
    }

    bind() {
      this.chatBtn?.addEventListener('click', () => this.handleAsk());
      this.chatInput?.addEventListener('keypress', e => {
        if (e.key === 'Enter' && !this.isLoading) this.handleAsk();
      });
      this.homeNavBtn?.addEventListener('click', () => this.startNewSearch());
      this.profileNavBtn?.addEventListener('click', () => this.showComingSoon("My Profile"));
      this.appointmentsNavBtn?.addEventListener('click', () => this.showComingSoon("Appointments"));
      this.basketNavBtn?.addEventListener('click', () => this.showComingSoon("Basket"));

      this.exampleBtns.forEach(btn => {
          btn.addEventListener('click', () => this.handleAsk(btn.dataset.query));
      });
    }

    welcome() {
        this.productsSection.style.display = 'none';
        this.welcomeSection.style.display = 'block';
        this.chatResponse.innerHTML = `
            <div style="text-align:center;color:#666;">
            <h3 style="color:#333;margin-bottom:12px;">Welcome to Your AI Salon</h3>
            <p style="margin-bottom:16px;">I'm here to give you personalized product recommendations.</p>
            <p style="font-size:13px;"><strong>Try:</strong></p>
            <ul style="text-align:left;font-size:12px;margin-top:8px;padding-left:20px;">
                <li>"shampoo"</li>
                <li>"serum"</li>
                <li>"bond repair"</li>
                <li>"accessories"</li>
            </ul>
            </div>`;
    }

    async handleAsk(message = this.chatInput?.value) {
      if (!message || this.isLoading) return;

      this.isLoading = true;
      if (this.chatBtn) { this.chatBtn.disabled = true; this.chatBtn.textContent = '...'; }
      this.aiStatus?.classList.add('active');
      this.welcomeSection.style.display = 'none';

      try {
        const data = await fetchUnifiedService(message);
        
        this.renderChat(data.chatResponse);

        if (data.products && data.products.length > 0) {
            this.renderProducts(data.products, message);
        } else {
            this.empty();
        }

      } catch (err) {
        console.error('Unified API request failed:', err);
        this.renderChat("I'm sorry, I could not connect to the service. Please try again.");
        this.empty();
      }

      if (this.chatInput) this.chatInput.value = '';
      this.isLoading = false;
      if (this.chatBtn) { this.chatBtn.disabled = false; this.chatBtn.textContent = 'Ask AI'; }
      this.aiStatus?.classList.remove('active');
    }
    
    renderChat(text) {
      if (!this.chatResponse) return;
      
      const chatContainer = qs('#chatResponse');
      chatContainer.innerHTML = '';
      
      const paragraphs = text.split('\n\n');
      let i = 0;
      
      const typeWriter = () => {
          if (i < paragraphs.length) {
              const p = document.createElement('p');
              p.className = 'chat-paragraph';
              p.textContent = paragraphs[i];
              chatContainer.appendChild(p);
              i++;
              setTimeout(typeWriter, 50);
          }
      };

      typeWriter();
    }

    renderProducts(products, query) {
      this.productsSection.style.display = 'block';
      this.grid.innerHTML = '';
      
      products.forEach(p => this.grid.appendChild(this.card(normalizeProduct(p))));
      
      if (this.status) {
        this.status.textContent = `Showing ${products.length} of ${products.length} products for "${query}"`;
      }
    }
    
    card(p) {
      const div = document.createElement('div');
      div.className = `product-card`;
      const price = formatCents(p.priceCents);
      const benefits = p.benefits?.length ? `<div class="product-benefits">${p.benefits.map(b=>`<span class="benefit-tag">${b}</span>`).join('')}</div>` : '';
      div.innerHTML = `
        <div class="product-content">
          <img class="product-image" loading="lazy" referrerpolicy="no-referrer"
               src="${(p.image||'').replace(/"/g,'&quot;')}"
               alt="${(p.name||'Product').replace(/"/g,'&quot;')}"
               onerror="this.outerHTML='<div class=\\'product-image-placeholder\\'>💆‍♀️</div>'">
          <div class="product-info">
            <div class="product-name">${p.name}</div>
            <div class="product-meta">${p.brand} • ${p.category}</div>
            ${p.description ? `<div class="product-description">${p.description}</div>` : ''}
            ${benefits}
            <div class="product-footer">
              <div class="product-price">${price}</div>
              <div class="product-actions">
                <button class="details-btn">Details</button>
              </div>
            </div>
          </div>
        </div>`;
      div.querySelector('.details-btn')?.addEventListener('click', () => this.details(p));
      return div;
    }

    details(p) {
      const lines = [];
      if (p.usage) lines.push(`Usage: ${p.usage}`);
      if (p.instructions) lines.push(`Instructions: ${p.instructions}`);
      if (p.ingredients) lines.push(`Key Ingredients: ${p.ingredients}`);
      if (p.benefits?.length) lines.push(`Benefits: ${p.benefits.join(', ')}`);
      alert(`${p.name}\n\n${lines.join('\n\n') || p.description || 'Professional salon product.'}`);
    }

    empty() {
      if (!this.grid) return;
      this.grid.innerHTML = `
        <div class="empty-state">
          <h3>No products found</h3>
          <p>Try a different search or be more specific about your needs.</p>
        </div>`;
    }
    
    startNewSearch() {
        window.scrollTo(0, 0);
        this.currentQuery = '';
        this.grid.innerHTML = '';
        this.productsSection.style.display = 'none';
        this.status.textContent = '';
        this.welcome();
    }
    
    showComingSoon(feature) {
        alert(`${feature} functionality is coming soon!`);
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
    window.salonAI = new UnifiedSalonAI();
  });
})();
</script>
</body>
</html>
