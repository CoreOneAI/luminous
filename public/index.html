<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Salon Consultant - Luminous</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#111;color:#333;line-height:1.4;overflow-x:hidden}
    .container{max-width:414px;margin:0 auto;background:#f8f8f8;min-height:100vh;padding-bottom:100px}
    .header{background:linear-gradient(135deg,#B8860B,#DAA520);color:#fff;padding:24px 16px;text-align:center;position:sticky;top:0;z-index:100;box-shadow:0 2px 20px rgba(0,0,0,.15)}
    .header h1{font-size:20px;font-weight:800;letter-spacing:.5px;margin-bottom:4px}
    .header .tagline{font-size:12px;opacity:.9}
    .main{padding:20px 16px}
    .welcome-section{background:#fff;border-radius:16px;padding:20px;margin-bottom:20px;border:1px solid #eee;box-shadow:0 4px 12px rgba(0,0,0,.05);text-align:center}
    .welcome-title{font-size:18px;font-weight:700;color:#222;margin-bottom:8px}
    .welcome-text{font-size:14px;color:#666;margin-bottom:16px;line-height:1.5}
    .quick-examples{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:16px}
    .example-btn{background:#f8f9fa;border:1px solid #e9ecef;border-radius:10px;padding:12px 8px;font-size:11px;text-align:center;cursor:pointer;color:#495057;font-weight:500;transition:all .2s ease}
    .example-btn:hover{border-color:#B8860B;color:#B8860B;transform:translateY(-1px)}
    .client-profile{background:#fff;border-radius:16px;padding:18px;margin-bottom:20px;border:1px solid #eee;box-shadow:0 4px 12px rgba(0,0,0,.05)}
    .profile-title{font-weight:700;font-size:15px;color:#222;margin-bottom:14px;text-align:center}
    .profile-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .profile-select{padding:12px;border:1px solid #ddd;border-radius:10px;font-size:13px;background:#fff;outline:none;color:#495057}
    .profile-select:focus{border-color:#B8860B;box-shadow:0 0 0 2px rgba(184,134,11,.1)}
    .chat-section{margin-bottom:24px}
    .chat-input-container{background:#fff;border-radius:16px;padding:6px;border:2px solid #e9ecef;box-shadow:0 4px 12px rgba(0,0,0,.05);display:flex;align-items:center;gap:8px}
    .chat-input-container:focus-within{border-color:#B8860B;box-shadow:0 4px 20px rgba(184,134,11,.15)}
    .chat-input{flex:1;padding:16px;border:none;font-size:15px;outline:none;background:transparent;color:#333}
    .chat-input::placeholder{color:#999}
    .chat-btn{padding:12px 16px;background:linear-gradient(135deg,#B8860B,#DAA520);color:#fff;border:none;border-radius:12px;font-weight:700;cursor:pointer;font-size:14px;min-width:60px;transition:all .2s ease}
    .chat-btn:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 4px 12px rgba(184,134,11,.3)}
    .chat-btn:disabled{opacity:.6;cursor:not-allowed}
    .ai-status{background:linear-gradient(135deg,#e7f3ff,#f0f8ff);color:#06c;padding:12px 16px;border-radius:12px;font-size:13px;margin:16px 0;text-align:center;border:1px solid #cce7ff;display:none;animation:pulse 2s infinite}
    .ai-status.active{display:block}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
    .chat-response{background:#fff;border-radius:16px;padding:18px;border:1px solid #eee;box-shadow:0 4px 12px rgba(0,0,0,.05);font-size:14px;line-height:1.6;color:#333;margin-bottom:20px}
    .products-section{margin-top:24px}
    .section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .section-title{font-size:17px;font-weight:700;color:#222}
    .ai-badge{background:#e7f3ff;color:#06c;padding:4px 10px;border-radius:20px;font-size:10px;font-weight:600;border:1px solid #cce7ff}
    .products-grid{display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:20px}
    .product-card{background:#fff;border-radius:16px;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.08);border:1px solid #f0f0f0;transition:all .3s ease}
    .product-card:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,.12)}
    .product-card.ai-generated{border-left:4px solid #B8860B}
    .product-content{display:grid;grid-template-columns:100px 1fr;gap:16px}
    .product-image{width:100px;height:100px;border-radius:12px;object-fit:cover;margin:16px 0 16px 16px}
    .product-image-placeholder{width:100px;height:100px;background:linear-gradient(135deg,#f0f0f0,#e8e8e8);display:flex;align-items:center;justify-content:center;color:#999;font-size:24px;margin:16px 0 16px 16px;border-radius:12px}
    .product-info{padding:16px 16px 16px 0}
    .product-name{font-weight:700;font-size:15px;color:#222;margin-bottom:4px;line-height:1.3}
    .product-meta{font-size:12px;color:#666;margin-bottom:8px}
    .product-description{font-size:12px;color:#555;line-height:1.4;margin-bottom:10px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .product-benefits{margin-bottom:10px;display:none}
    .product-benefits.visible{display:block}
    .benefit-tag{display:inline-block;background:#f0f8ff;color:#06c;padding:2px 6px;border-radius:4px;font-size:10px;margin:1px;border:1px solid #cce7ff}
    .product-footer{display:flex;justify-content:space-between;align-items:center}
    .product-price{font-weight:700;color:#B8860B;font-size:16px}
    .product-actions{display:flex;gap:8px}
    .details-btn{background:#f8f9fa;color:#666;border:1px solid #ddd;border-radius:8px;padding:6px 10px;font-size:11px;font-weight:600;cursor:pointer}
    .add-btn{background:linear-gradient(135deg,#28a745,#20c997);color:#fff;border:none;border-radius:8px;padding:6px 12px;font-size:11px;font-weight:600;cursor:pointer}
    .load-more{text-align:center;margin:24px 0}
    .load-more-btn{background:linear-gradient(135deg,#B8860B,#DAA520);color:#fff;border:none;border-radius:16px;padding:14px 18px;font-weight:600;cursor:pointer;font-size:14px}
    .home-btn{background:#f8f9fa;color:#666;border:1px solid #ddd;border-radius:16px;padding:14px 18px;font-weight:600;cursor:pointer;font-size:14px;margin-left:8px}
    .status{text-align:center;color:#666;font-size:13px;margin-bottom:16px;padding:12px;background:#fff;border-radius:12px}
    .error{background:#fee;color:#c33;padding:16px;border-radius:12px;margin:16px 0;font-size:13px;border:1px solid #fcc}
    .empty-state{text-align:center;padding:40px 20px;color:#666}
    .empty-state h3{font-size:16px;margin-bottom:8px;color:#333}
    .empty-state p{font-size:13px;line-height:1.5}
    @media (max-width:380px){.container{max-width:100%}.profile-grid{grid-template-columns:1fr}.quick-examples{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>AI Salon Consultant</h1>
      <div class="tagline">Your personal beauty expert powered by AI</div>
    </header>

    <main class="main">
      <section class="welcome-section">
        <div class="welcome-title">Welcome to Your Personal Salon</div>
        <div class="welcome-text">Tell me about your hair, skin, or beauty goals and I'll recommend the perfect professional products just for you.</div>
        <div class="quick-examples">
          <button class="example-btn" onclick="quickAsk('repair damaged curly hair')">Repair Damage</button>
          <button class="example-btn" onclick="quickAsk('anti-aging skincare routine')">Anti-Aging</button>
          <button class="example-btn" onclick="quickAsk('accessories')">Accessories</button>
          <button class="example-btn" onclick="quickAsk('acne-prone sensitive skin')">Clear Skin</button>
        </div>
      </section>

      <section class="client-profile">
        <div class="profile-title">Tell Me About Yourself</div>
        <div class="profile-grid">
          <select class="profile-select" id="hairType">
            <option value="">Hair Type</option>
            <option value="straight">Straight</option>
            <option value="wavy">Wavy</option>
            <option value="curly">Curly</option>
            <option value="coily">Coily/Kinky</option>
          </select>
          <select class="profile-select" id="skinType">
            <option value="">Skin Type</option>
            <option value="oily">Oily</option>
            <option value="dry">Dry</option>
            <option value="combination">Combination</option>
            <option value="sensitive">Sensitive</option>
          </select>
          <select class="profile-select" id="concerns">
            <option value="">Main Concerns</option>
            <option value="damage">Damage/Breakage</option>
            <option value="frizz">Frizz Control</option>
            <option value="volume">Volume</option>
            <option value="color">Color Protection</option>
            <option value="aging">Anti-Aging</option>
            <option value="acne">Acne</option>
            <option value="dryness">Dryness</option>
          </select>
          <select class="profile-select" id="budget">
            <option value="">Budget Range</option>
            <option value="budget">Budget ($10-30)</option>
            <option value="mid">Mid-Range ($30-60)</option>
            <option value="luxury">Luxury ($60+)</option>
          </select>
        </div>
      </section>

      <section class="chat-section">
        <div class="chat-input-container">
          <input id="chatInput" class="chat-input" placeholder="Ask me anything... 'I need products for dry, frizzy hair'" autocomplete="off">
          <button id="chatBtn" class="chat-btn">Ask AI</button>
        </div>

        <div id="aiStatus" class="ai-status">AI is generating personalized recommendations...</div>

        <div id="chatResponse" class="chat-response">
          Hi! I'm your AI salon consultant. Tell me about your hair, skin, or beauty concerns, and I'll recommend the perfect professional products tailored specifically for you.
        </div>
      </section>

      <section id="productsSection" class="products-section" style="display:none;">
        <div class="section-header">
          <div class="section-title">Your Recommendations</div>
          <div class="ai-badge">AI Generated</div>
        </div>

        <div id="status" class="status"></div>
        <div id="productsGrid" class="products-grid"></div>

        <div id="loadMoreSection" class="load-more" style="display:none;">
          <button id="loadMoreBtn" class="load-more-btn">Show More Products</button>
          <button class="home-btn" onclick="location.reload()">Start New Search</button>
        </div>

        <!-- sentinel for infinite scroll -->
        <div id="sentinel" style="height:1px;"></div>
      </section>
    </main>
  </div>

  <script>
(() => {
  class UnifiedSalonAI {
    constructor() {
      this.currentQuery = '';
      this.currentOffset = 0;
      this.totalProducts = 0;
      this.pageSize = 25; // keep your 25-per batch
      this.isLoading = false;

      // Elements
      this.chatInput = document.getElementById('chatInput');
      this.chatBtn = document.getElementById('chatBtn');
      this.chatResponse = document.getElementById('chatResponse');
      this.aiStatus = document.getElementById('aiStatus');
      this.status = document.getElementById('status');
      this.grid = document.getElementById('productsGrid');
      this.loadMoreSection = document.getElementById('loadMoreSection');
      this.loadMoreBtn = document.getElementById('loadMoreBtn');
      this.productsSection = document.getElementById('productsSection');

      // Profile
      this.hairType = document.getElementById('hairType');
      this.skinType = document.getElementById('skinType');
      this.concerns = document.getElementById('concerns');
      this.budget = document.getElementById('budget');

      this.bindEvents();
      this.showWelcomeMessage();
    }

    bindEvents() {
      if (this.chatBtn) {
        this.chatBtn.addEventListener('click', () => this.handleAIConsultation());
      }
      if (this.chatInput) {
        this.chatInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter' && !this.isLoading) this.handleAIConsultation();
        });
      }
      if (this.loadMoreBtn) {
        this.loadMoreBtn.addEventListener('click', () => this.loadMore());
      }

      [this.hairType, this.skinType, this.concerns, this.budget].forEach(sel => {
        if (sel) sel.addEventListener('change', () => this.onProfileChange());
      });
    }

    showWelcomeMessage() {
      if (!this.chatResponse) return;
      this.chatResponse.innerHTML = `
        <div style="text-align: center; color: #666;">
          <h3 style="color: #333; margin-bottom: 12px;">Welcome to Your AI Salon</h3>
          <p style="margin-bottom: 16px;">I'm here to give you personalized product recommendations based on your unique needs.</p>
          <p style="font-size: 13px;"><strong>Try asking:</strong></p>
          <ul style="text-align: left; font-size: 12px; margin-top: 8px; padding-left: 20px;">
            <li>"I have dry, damaged hair - what should I use?"</li>
            <li>"Best anti-aging products for sensitive skin"</li>
            <li>"Products for oily skin and acne"</li>
            <li>"Volume routine for fine, straight hair"</li>
          </ul>
        </div>
      `;
    }

    onProfileChange() {
      if (this.currentQuery) this.searchProducts(this.currentQuery, true);
    }

    async handleAIConsultation() {
      const message = (this.chatInput?.value || '').trim();
      if (!message || this.isLoading) return;

      this.isLoading = true;
      if (this.chatBtn) { this.chatBtn.disabled = true; this.chatBtn.textContent = '...'; }
      this.aiStatus?.classList.add('active');
      if (this.productsSection) this.productsSection.style.display = 'block';

      try {
        // Try chat, but DO NOT block products if chat fails
        await this.safeChatResponse(message);

        // Always search products
        this.currentQuery = message;
        await this.searchProducts(message, true);

        if (this.chatInput) this.chatInput.value = '';
      } catch (err) {
        console.error('Consultation error:', err);
        this.showChatError('I had trouble processing that. Please try again.');
      } finally {
        this.isLoading = false;
        if (this.chatBtn) { this.chatBtn.disabled = false; this.chatBtn.textContent = 'Ask AI'; }
        this.aiStatus?.classList.remove('active');
      }
    }

    async safeChatResponse(message) {
      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message })
        });
        if (!res.ok) throw new Error(`chat ${res.status}`);
        const data = await res.json();
        this.renderChat(data?.response);
      } catch {
        // Graceful fallback if /api/chat doesn’t exist or fails
        this.renderChat(null);
      }
    }

    renderChat(text) {
      if (!this.chatResponse) return;
      this.chatResponse.innerHTML = `
        <div style="border-left: 4px solid #B8860B; padding-left: 16px;">
          <h4 style="color: #B8860B; margin-bottom: 8px; font-size: 14px;">AI Consultation</h4>
          <p style="line-height: 1.6;">${text || 'Let me help you find the perfect products for your needs.'}</p>
        </div>
      `;
    }

    getClientProfile() {
      return {
        hairType: this.hairType?.value || '',
        skinType: this.skinType?.value || '',
        concerns: this.concerns?.value || '',
        budget: this.budget?.value || ''
      };
    }

    async searchProducts(query, reset = false) {
      if (reset) {
        this.currentOffset = 0;
        if (this.grid) this.grid.innerHTML = '';
      }

      try {
        if (this.status) this.status.textContent = 'AI is generating your personalized product recommendations...';
        const profile = this.getClientProfile();
        const params = new URLSearchParams({
          q: query,
          limit: String(this.pageSize),
          offset: String(this.currentOffset),
          ...profile
        });

        const res = await fetch(`/api/products?${params.toString()}`);
        if (!res.ok) throw new Error(`products ${res.status}`);
        const data = await res.json();

        const items = Array.isArray(data?.items) ? data.items : [];
        // total may be absent → fallback to count; else estimate
        const total = (Number.isFinite(data?.total) ? data.total
                    : Number.isFinite(data?.count) ? data.count
                    : (this.currentOffset + items.length + (items.length === this.pageSize ? this.pageSize : 0)));

        this.totalProducts = Math.max(Number(total) || 0, this.currentOffset + items.length);
        this.currentOffset += items.length;

        if (items.length === 0 && reset) {
          this.showEmptyState();
        } else {
          this.renderProducts(items, !!data?.aiGenerated);
          this.updateStatus({ total: this.totalProducts, query: data?.query || query, aiGenerated: !!data?.aiGenerated });
          this.updateLoadMoreButton(items.length);
        }
      } catch (err) {
        console.error('Products error:', err);
        this.showProductError(err.message || 'Failed to load products');
      }
    }

    renderProducts(products, aiGenerated = false) {
      if (!this.grid) return;
      products.forEach(p => this.grid.appendChild(this.createProductCard(p, aiGenerated)));
    }

    createProductCard(product, aiGenerated = false) {
      const card = document.createElement('div');
      card.className = `product-card${aiGenerated ? ' ai-generated' : ''}`;

      const cents = this.getPriceCents(product);
      const priceText = this.formatCents(cents);
      const meta = `${product.brand ?? '—'} • ${product.category ?? '—'}`;

      const benefits = Array.isArray(product.benefits) && product.benefits.length
        ? product.benefits.map(b => `<span class="benefit-tag">${b}</span>`).join('')
        : '';

      const safeImg = (product.image || '').replace(/"/g, '&quot;');

      card.innerHTML = `
        <div class="product-content">
          ${safeImg
            ? `<img class="product-image" src="${safeImg}" alt="${product.name || 'Product'}" referrerpolicy="no-referrer"
                 onerror="this.outerHTML='<div class=\\'product-image-placeholder\\'>💆‍♀️</div>'">`
            : `<div class="product-image-placeholder">💆‍♀️</div>`}
          <div class="product-info">
            <div class="product-name">${product.name || 'Product'}</div>
            <div class="product-meta">${meta}</div>
            ${product.description ? `<div class="product-description">${product.description}</div>` : ''}
            ${benefits ? `<div class="product-benefits">${benefits}</div>` : ''}
            <div class="product-footer">
              <div class="product-price">${priceText}</div>
              <div class="product-actions">
                ${product.description ? '<button class="details-btn">Details</button>' : ''}
                <button class="add-btn" data-id="${product.id || ''}">Add to Cart</button>
              </div>
            </div>
          </div>
        </div>
      `;

      const detailsBtn = card.querySelector('.details-btn');
      if (detailsBtn) detailsBtn.addEventListener('click', () => this.showProductDetails(product));

      const addBtn = card.querySelector('.add-btn');
      if (addBtn) addBtn.addEventListener('click', () => this.addToCart(product));

      return card;
    }

    getPriceCents(product) {
      if (typeof product?.priceCents === 'number') return product.priceCents;
      if (typeof product?.price === 'number') return Math.round(product.price * 100);
      return NaN;
    }

    formatCents(cents) {
      if (!Number.isFinite(cents) || cents <= 0) return '$—';
      return '$' + (cents / 100).toFixed(2);
    }

    showProductDetails(product) {
      const lines = [];
      if (product.usage) lines.push(`Usage: ${product.usage}`);
      if (product.ingredients) lines.push(`Key Ingredients: ${product.ingredients}`);
      if (product.suitableFor) lines.push(`Perfect For: ${product.suitableFor}`);
      alert(`${product.name || 'Product'}\n\n${lines.join('\n\n') || (product.description || 'Professional salon product designed for optimal results.')}`);
    }

    showEmptyState() {
      if (!this.grid) return;
      this.grid.innerHTML = `
        <div class="empty-state">
          <h3>No products found</h3>
          <p>Try a different search or be more specific about your needs.</p>
        </div>
      `;
    }

    showChatError(message) {
      if (!this.chatResponse) return;
      this.chatResponse.innerHTML = `<div class="error">${message}</div>`;
    }

    showProductError(message) {
      if (this.status) this.status.innerHTML = `<div class="error">Error: ${message}</div>`;
    }

    updateStatus(data) {
      const showing = this.currentOffset;
      const total = Math.min(Number(data.total) || showing, 100);
      const type = data.aiGenerated ? 'AI recommendations' : 'products';
      if (this.status) {
        this.status.textContent = `Showing ${showing} of ${total} ${type} for "${data.query || this.currentQuery}"`;
      }
      this.totalProducts = total;
    }

    updateLoadMoreButton(lastBatchCount) {
      const hasMore = lastBatchCount === this.pageSize || this.currentOffset < this.totalProducts;
      if (!this.loadMoreSection) return;

      if (hasMore) {
        this.loadMoreSection.innerHTML = `
          <button class="load-more-btn" id="loadMoreBtn">Show More Products (${this.currentOffset}/${this.totalProducts})</button>
        `;
        const btn = document.getElementById('loadMoreBtn');
        if (btn) btn.addEventListener('click', () => this.loadMore());
        this.loadMoreSection.style.display = 'block';
      } else if (this.totalProducts > 0) {
        this.loadMoreSection.innerHTML = `<button class="home-btn" onclick="location.reload()">Start New Search</button>`;
        this.loadMoreSection.style.display = 'block';
      } else {
        this.loadMoreSection.style.display = 'none';
      }
    }

    addToCart(product) {
      const cents = this.getPriceCents(product);
      alert(`Added "${product.name || 'Product'}" to cart!\n\nPrice: ${this.formatCents(cents)}\n\n${product.description || 'Perfect for your needs!'}`);
    }

    loadMore() { this.searchProducts(this.currentQuery, false); }
  }

  window.addEventListener('DOMContentLoaded', () => {
    window.salonAI = new UnifiedSalonAI();
  });
})();
</script>

</body>
</html>
